# æ•°æ®åº“è¿ç§» Lambda å‡½æ•°ä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®åŒ…å«ä¸€ä¸ªä¸“é—¨çš„ AWS Lambda å‡½æ•°ç”¨äºæ‰§è¡Œ Prisma æ•°æ®åº“è¿ç§»ã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ¶æ„](#æ¶æ„)
- [éƒ¨ç½²](#éƒ¨ç½²)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

## æ¦‚è¿°

è¿ç§» Lambda å‡½æ•° (`MigrationFunction`) æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ— æœåŠ¡å™¨å‡½æ•°ï¼Œç”¨äºåœ¨ AWS Lambda ç¯å¢ƒä¸­æ‰§è¡Œ Prisma æ•°æ®åº“è¿ç§»ã€‚å®ƒä¸ä¸»åº”ç”¨ç¨‹åºå‡½æ•°åˆ†ç¦»ï¼Œå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œæ•°æ®åº“æ¨¡å¼å˜æ›´ã€‚

### ä¸»è¦ç‰¹æ€§

- âœ… **ç‹¬ç«‹éƒ¨ç½²**: ä¸åº”ç”¨ç¨‹åºåˆ†ç¦»ï¼Œé¿å…å½±å“ç”Ÿäº§æµé‡
- âœ… **VPC é›†æˆ**: åœ¨ VPC å†…è¿è¡Œï¼Œå®‰å…¨è®¿é—® RDS æ•°æ®åº“
- âœ… **å¤šç§æ“ä½œ**: æ”¯æŒéƒ¨ç½²ã€çŠ¶æ€æ£€æŸ¥å’Œé‡ç½®æ“ä½œ
- âœ… **è¯¦ç»†æ—¥å¿—**: CloudWatch æ—¥å¿—è®°å½•æ‰€æœ‰æ“ä½œ
- âœ… **è¶…æ—¶é…ç½®**: 5 åˆ†é’Ÿè¶…æ—¶ï¼Œé€‚åˆå¤§å‹è¿ç§»

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼€å‘è€…æœ¬åœ°ç¯å¢ƒ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ AWS CLI invoke
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MigrationFunction (Lambda)        â”‚
â”‚   - Handler: dist/src/migrate.handlerâ”‚
â”‚   - Timeout: 300s                    â”‚
â”‚   - Memory: 1024 MB                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ VPC Connection
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RDS Master DB     â”‚
â”‚   (PostgreSQL)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éƒ¨ç½²

### 1. æ„å»ºé¡¹ç›®

ç¡®ä¿è¿ç§»å‡½æ•°çš„ä»£ç å·²ç¼–è¯‘ï¼š

```bash
npm run build
```

### 2. éƒ¨ç½²åˆ° AWS

ä½¿ç”¨ SAM éƒ¨ç½²ï¼š

```bash
# ä½¿ç”¨ç°æœ‰çš„éƒ¨ç½²è„šæœ¬
bash scripts/deploy.sh

# æˆ–è€…æ‰‹åŠ¨éƒ¨ç½²
sam build
sam deploy --guided
```

éƒ¨ç½²å®Œæˆåï¼ŒCloudFormation ä¼šè¾“å‡º `MigrationFunctionName` å’Œ `MigrationFunctionArn`ã€‚

## ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ NPM è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æ‰§è¡Œå¾…å¤„ç†çš„è¿ç§»
npm run migrate:deploy

# æ£€æŸ¥è¿ç§»çŠ¶æ€
npm run migrate:status

# é‡ç½®æ•°æ®åº“ï¼ˆå±é™©æ“ä½œï¼ï¼‰
npm run migrate:reset
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Shell è„šæœ¬

```bash
# æ‰§è¡Œå¾…å¤„ç†çš„è¿ç§»
bash scripts/run-migration.sh deploy

# æ£€æŸ¥è¿ç§»çŠ¶æ€
bash scripts/run-migration.sh status

# é‡ç½®æ•°æ®åº“
bash scripts/run-migration.sh reset
```

### æ–¹å¼ä¸‰ï¼šç›´æ¥ä½¿ç”¨ AWS CLI

```bash
# è·å–å‡½æ•°åç§°
FUNCTION_NAME=$(aws cloudformation describe-stacks \
  --stack-name scenery-mpa-nest-dev \
  --query "Stacks[0].Outputs[?OutputKey=='MigrationFunctionName'].OutputValue" \
  --output text)

# æ‰§è¡Œè¿ç§»
aws lambda invoke \
  --function-name $FUNCTION_NAME \
  --payload '{"action":"deploy"}' \
  --cli-binary-format raw-in-base64-out \
  response.json

# æŸ¥çœ‹å“åº”
cat response.json | jq
```

## æ”¯æŒçš„æ“ä½œ

### 1. Deployï¼ˆéƒ¨ç½²è¿ç§»ï¼‰

æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†çš„æ•°æ®åº“è¿ç§»ã€‚

```bash
npm run migrate:deploy
```

**é€‚ç”¨åœºæ™¯**ï¼š
- éƒ¨ç½²æ–°çš„æ•°æ®åº“æ¨¡å¼å˜æ›´
- åº”ç”¨æ–°åˆ›å»ºçš„ Prisma è¿ç§»æ–‡ä»¶
- åˆå§‹åŒ–æ–°ç¯å¢ƒçš„æ•°æ®åº“

### 2. Statusï¼ˆæ£€æŸ¥çŠ¶æ€ï¼‰

æ£€æŸ¥æ•°æ®åº“è¿ç§»çš„å½“å‰çŠ¶æ€ã€‚

```bash
npm run migrate:status
```

**è¿”å›ä¿¡æ¯**ï¼š
- å·²åº”ç”¨çš„è¿ç§»
- å¾…å¤„ç†çš„è¿ç§»
- è¿ç§»å†å²

### 3. Resetï¼ˆé‡ç½®æ•°æ®åº“ï¼‰

**âš ï¸ å±é™©æ“ä½œï¼** åˆ é™¤æ‰€æœ‰æ•°æ®å¹¶é‡æ–°åº”ç”¨è¿ç§»ã€‚

```bash
npm run migrate:reset
```

**ä½¿ç”¨é™åˆ¶**ï¼š
- éœ€è¦åœ¨äº‹ä»¶è´Ÿè½½ä¸­æ˜ç¡®è®¾ç½® `forceReset: true`
- ä¼šæç¤ºç¡®è®¤æ“ä½œ
- ä»…åœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒä½¿ç”¨

## ç¯å¢ƒå˜é‡

è¿ç§»å‡½æ•°ä½¿ç”¨ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼ˆç”± SAM æ¨¡æ¿è‡ªåŠ¨é…ç½®ï¼‰ï¼š

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `DATABASE_URL` | ä¸»æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² | `postgresql://user:pass@host:5432/db` |
| `NODE_ENV` | è¿è¡Œç¯å¢ƒ | `dev`, `staging`, `prod` |

## æŸ¥çœ‹æ—¥å¿—

### ä½¿ç”¨ AWS CLI

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
aws logs tail /aws/lambda/<FUNCTION_NAME> --follow

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
aws logs tail /aws/lambda/<FUNCTION_NAME> --since 1h
```

### ä½¿ç”¨ CloudWatch Console

1. è®¿é—® AWS CloudWatch Console
2. å¯¼èˆªåˆ° Log groups
3. æ‰¾åˆ° `/aws/lambda/<stack-name>-db-migration`
4. æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—æµ

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è¶…æ—¶é”™è¯¯

**ç—‡çŠ¶**ï¼šè¿ç§»æ‰§è¡Œè¶…è¿‡ 5 åˆ†é’Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥è¿ç§» SQL æ˜¯å¦åŒ…å«è€—æ—¶æ“ä½œ
2. è€ƒè™‘æ‹†åˆ†å¤§å‹è¿ç§»ä¸ºå¤šä¸ªå°è¿ç§»
3. å¦‚éœ€è¦ï¼Œåœ¨ `template.yaml` ä¸­å¢åŠ  `Timeout` å€¼

### é—®é¢˜ 2: VPC è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šæ— æ³•è¿æ¥åˆ° RDS æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. éªŒè¯ Lambda å®‰å…¨ç»„å…è®¸å‡ºç«™æµé‡
2. ç¡®è®¤ RDS å®‰å…¨ç»„å…è®¸æ¥è‡ª Lambda å®‰å…¨ç»„çš„å…¥ç«™æµé‡ï¼ˆç«¯å£ 5432ï¼‰
3. æ£€æŸ¥ NAT Gateway æ˜¯å¦æ­£å¸¸è¿è¡Œ

### é—®é¢˜ 3: Prisma å‘½ä»¤æœªæ‰¾åˆ°

**ç—‡çŠ¶**ï¼š`npx prisma` å‘½ä»¤æ‰§è¡Œå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ `prisma` å·²åœ¨ `package.json` çš„ `devDependencies` ä¸­
2. éªŒè¯æ„å»ºè¿‡ç¨‹åŒ…å«äº† `node_modules`
3. æ£€æŸ¥ `prisma/migrations` ç›®å½•å·²åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­

### é—®é¢˜ 4: æƒé™é”™è¯¯

**ç—‡çŠ¶**ï¼šLambda å‡½æ•°æ— æ³•åˆ›å»ºæ—¥å¿—æˆ–è®¿é—® VPC

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Lambda æ‰§è¡Œè§’è‰²åŒ…å« `VPCAccessPolicy`
2. ç¡®è®¤æ—¥å¿—æƒé™å·²æ­£ç¡®é…ç½®
3. æŸ¥çœ‹ IAM è§’è‰²ç­–ç•¥

## åˆ›å»ºæ–°è¿ç§»

åœ¨æœ¬åœ°åˆ›å»º Prisma è¿ç§»ï¼š

```bash
# 1. ä¿®æ”¹ prisma/schema.prisma æ–‡ä»¶

# 2. åˆ›å»ºè¿ç§»
npx prisma migrate dev --name your_migration_name

# 3. æ„å»ºé¡¹ç›®
npm run build

# 4. é‡æ–°éƒ¨ç½²
sam build && sam deploy

# 5. æ‰§è¡Œè¿ç§»
npm run migrate:deploy
```

## æœ€ä½³å®è·µ

1. **æµ‹è¯•è¿ç§»**ï¼šå…ˆåœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•æ‰€æœ‰è¿ç§»
2. **å¤‡ä»½æ•°æ®**ï¼šç”Ÿäº§ç¯å¢ƒè¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
3. **å°æ­¥è¿­ä»£**ï¼šå°†å¤§å‹æ¨¡å¼å˜æ›´æ‹†åˆ†ä¸ºå¤šä¸ªå°è¿ç§»
4. **ç›‘æ§æ—¥å¿—**ï¼šæ‰§è¡Œè¿ç§»æ—¶å®æ—¶ç›‘æ§ CloudWatch æ—¥å¿—
5. **å›æ»šè®¡åˆ’**ï¼šå‡†å¤‡å¥½å›æ»šç­–ç•¥ä»¥åº”å¯¹å¤±è´¥æƒ…å†µ
6. **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ‰€æœ‰è¿ç§»æ–‡ä»¶å¿…é¡»çº³å…¥ç‰ˆæœ¬æ§åˆ¶

## å®‰å…¨æ³¨æ„äº‹é¡¹

- âš ï¸ **ç”Ÿäº§ç¯å¢ƒ** æ°¸è¿œä¸è¦ä½¿ç”¨ `migrate:reset`
- ğŸ”’ æ•°æ®åº“å‡­è¯é€šè¿‡ CloudFormation å‚æ•°å®‰å…¨ä¼ é€’
- ğŸ” Lambda å‡½æ•°è¿è¡Œåœ¨ç§æœ‰å­ç½‘ï¼Œæ— å…¬ç½‘è®¿é—®
- ğŸ“ æ‰€æœ‰æ“ä½œéƒ½è®°å½•åœ¨ CloudWatch æ—¥å¿—ä¸­

## ç›¸å…³æ–‡ä»¶

- `src/migrate.ts` - è¿ç§» Lambda å‡½æ•°æºä»£ç 
- `scripts/run-migration.sh` - è¿ç§»æ‰§è¡Œè„šæœ¬
- `template.yaml` - SAM æ¨¡æ¿é…ç½®ï¼ˆMigrationFunction éƒ¨åˆ†ï¼‰
- `prisma/migrations/` - Prisma è¿ç§»æ–‡ä»¶ç›®å½•
- `prisma/schema.prisma` - Prisma æ•°æ®æ¨¡å‹

## å‚è€ƒèµ„æ–™

- [Prisma Migrate æ–‡æ¡£](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [AWS Lambda æ–‡æ¡£](https://docs.aws.amazon.com/lambda/)
- [AWS SAM æ–‡æ¡£](https://docs.aws.amazon.com/serverless-application-model/)
